type: fragment
using: [ wikipediaInfo, config ]
providing: download
components:
  downloadLocation:
    sql: |
      select 
        /*+ REPARTITION(4) */
        *,
        concat((select fileDumpLocation from config), "/", language, "_", date, "_", fileName) as fileLocation
      from 
        wikipediaInfo
  download:
    udfs:
      list: 
        - type: scala
          name: downloadUrl
          scala: |
            (url:String, location:String) => {
              try {
                val url = new java.net.URL(url)
                val file = new java.io.File(location)
                org.apache.commons.io.FileUtils.copyURLToFile(url, file)
                true
              } catch {
                case _: Throwable  => false
              }
            }
    sql: |
      select 
        *,
        downloadUrl(fileUrl, fileLocation) as downloadOutcome
      from 
        downloadLocation